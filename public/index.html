<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFT Console V5.0</title>

    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">

    <style>
        /* Inspector 패널 스타일 (기존 유지) */
        #inspector-panel {
            position: fixed !important;
            left: 0 !important;
            right: 0 !important;
            bottom: -100% !important;
            width: 100vw !important;
            margin: 0 !important;
            height: 350px;
            min-height: 200px;
            max-height: 85vh;
            background: #1a1a1a !important;
            border-top: 1px solid #444 !important;
            z-index: 9999 !important;
            display: flex !important;
            flex-direction: column !important;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.5) !important;
            transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        #inspector-panel.open {
            bottom: 0 !important;
        }

        .resize-handle {
            height: 12px;
            background: #252525;
            border-bottom: 1px solid #333;
            cursor: ns-resize;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .resize-handle::after {
            content: '';
            width: 40px;
            height: 4px;
            background: #555;
            border-radius: 2px;
        }

        .inspector-body {
            display: flex !important;
            flex-direction: row !important;
            gap: 20px !important;
            padding: 15px 20px !important;
            overflow-y: hidden !important;
            flex: 1;
            width: 100%;
        }

        .inspector-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #222;
            border: 1px solid #444;
            border-radius: 6px;
            padding: 10px;
            overflow-y: auto;
        }

        .inspector-column:nth-child(2) {
            flex: 1.5;
        }

        /* Toast & Conveyor 스타일 */
        #toast-container {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .toast-msg {
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 14px;
            border: 1px solid #555;
            animation: fadeInOut 3s forwards;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @keyframes fadeInOut {

            0%,
            100% {
                opacity: 0;
                transform: translateY(-10px);
            }

            10%,
            90% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .conv-display.done {
            background: rgba(46, 204, 113, 0.05) !important;
            border: 2px solid #2ecc71 !important;
        }

        .conv-display.done::before {
            content: "✔ AI Generated";
            display: block;
            background: #2ecc71;
            color: black;
            font-weight: bold;
            font-size: 11px;
            padding: 4px 8px;
            width: fit-content;
            border-radius: 4px;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div id="toast-container"></div>

    <aside id="sidebar">
        <div class="sb-header">
            <span>SFT Project List</span>
            <div class="sb-filter">
                <button class="btn-filter active">이름순</button>
                <button class="btn-filter">최신순</button>
            </div>
            <button class="btn" style="width:100%; background:#222;" id="btn-new-project">+ New Project</button>
        </div>
        <div class="sb-list" id="project-list"></div>
    </aside>

    <main id="main-area">
        <header id="top-bar"
            style="height: 50px; background: #1a1a1a; border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px;">
            <div class="logo-area" style="font-weight: bold; font-size: 16px; color: #3498db;">
                <i class="fas fa-dice-d20"></i> SFT Console V5.0
            </div>
            <div class="view-tabs" style="display: flex; gap: 5px;">
                <div class="tab-btn active" data-target="dashboard"><i class="fas fa-columns"></i> Dashboard</div>
                <div class="tab-btn" data-target="director"><i class="fas fa-film"></i> The Director</div>
                <div class="tab-btn" data-target="conveyor"><i class="fas fa-rocket"></i> Conveyor</div>
            </div>
            <div class="top-actions" style="display: flex; gap: 10px;">
                <button class="btn" id="btn-save-local"><i class="fas fa-download"></i> Save Local</button>
                <button class="btn" id="btn-settings" style="background:#34495e; border-color:#46637f;"><i
                        class="fas fa-cog"></i> Settings</button>
            </div>
        </header>

        <section id="view-dashboard" class="view-section active">
            <div class="card" style="margin-bottom: 20px;">
                <h3><i class="fas fa-info-circle"></i> Basic Info</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div>
                        <label style="font-size: 12px; color: #aaa;">Project Title</label>
                        <input type="text" id="inp-title" style="width: 100%; margin-top: 5px;"
                            placeholder="Project Name">
                    </div>
                    <div id="row-gems-s1">
                        <label style="font-size: 12px; color: #aaa;">Stage 1 Gems URL</label>
                        <div class="data-actions" style="margin-top: 5px;">
                            <div id="ver-gems-s1"
                                style="flex: 1; background: #111; padding: 6px; border: 1px solid #444; border-radius: 4px; font-size: 12px; color: #888; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                                No Data</div>
                            <button class="btn" onclick="openEditor('gems','s1')">Edit</button>
                            <button class="btn" onclick="openUrl('gems','s1')">Go</button>
                        </div>
                    </div>
                    <div id="row-gems-s2">
                        <label style="font-size: 12px; color: #aaa;">Stage 2 Gems URL</label>
                        <div class="data-actions" style="margin-top: 5px;">
                            <div id="ver-gems-s2"
                                style="flex: 1; background: #111; padding: 6px; border: 1px solid #444; border-radius: 4px; font-size: 12px; color: #888; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
                                No Data</div>
                            <button class="btn" onclick="openEditor('gems','s2')">Edit</button>
                            <button class="btn" onclick="openUrl('gems','s2')">Go</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="dash-grid">
                <div class="card">
                    <h3><i class="fas fa-file-alt"></i> Stage 1 (Data Structure)</h3>
                    <div class="data-row" id="row-s1-prompt">
                        <div>
                            <div class="data-info">System Prompt</div>
                            <div class="data-ver" id="ver-s1-prompt">No Data</div>
                        </div>
                        <div class="data-actions"><button class="btn" onclick="openEditor('s1','prompt')">Edit</button>
                        </div>
                    </div>
                    <div class="data-row" id="row-s1-json">
                        <div>
                            <div class="data-info">Result JSON</div>
                            <div class="data-ver" id="ver-s1-json">No Data</div>
                        </div>
                        <div class="data-actions"><button class="btn" onclick="openEditor('s1','json')">Edit</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h3><i class="fas fa-clapperboard"></i> Stage 2 (Action Plan)</h3>
                    <div class="data-row" id="row-s2-prompt">
                        <div>
                            <div class="data-info">System Prompt</div>
                            <div class="data-ver" id="ver-s2-prompt">No Data</div>
                        </div>
                        <div class="data-actions"><button class="btn" onclick="openEditor('s2','prompt')">Edit</button>
                        </div>
                    </div>
                    <div class="data-row" id="row-s2-json">
                        <div>
                            <div class="data-info">Result JSON (Director Input)</div>
                            <div class="data-ver" id="ver-s2-json">No Data</div>
                        </div>
                        <div class="data-actions"><button class="btn" onclick="openEditor('s2','json')">Edit</button>
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" style="width: 100%; padding: 10px;"
                            onclick="loadToDirector()">Load to Director <i class="fas fa-play"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-director" class="view-section">
            <div id="timeline-header">
                <div class="header-controls">
                    <span style="font-size:12px; color:#aaa;">Timeline</span>
                    <button class="btn" onclick="fitTimeline()"><i class="fas fa-compress"></i> Fit</button>
                    <input type="range" id="zoom-slider" min="0.2" max="10" step="0.1" value="5" style="width:100px;">
                </div>
                <div id="timeline-ruler"></div>
            </div>
            <div id="track-area">
                <div id="track-content"></div>
            </div>
        </section>

        <section id="view-conveyor" class="view-section" style="background: #111;"></section>
    </main>

    <aside id="inspector-panel">
        <div class="resize-handle" title="Drag to resize height"></div>
        <div class="inspector-header">
            <span style="font-weight:bold; color:white;"><i class="fas fa-cube"></i> Scene: <span
                    id="inspector-scene-id" style="color:var(--primary)">-</span></span>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-primary" id="btn-inspector-ai"
                    style="background: #8e44ad; border-color: #8e44ad;"><i class="fas fa-magic"></i> AI
                    Directing</button>
                <button class="btn" onclick="saveInspector()">Save <i class="fas fa-check"></i></button>
                <button class="btn-icon"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="inspector-body">
            <div class="inspector-column">
                <div style="font-size:11px; font-weight:bold; color:#888; margin-bottom:5px;">NARRATION</div>
                <div class="narration-section">
                    <div id="inspector-narration" class="narration-text"></div>
                </div>
            </div>
            <div class="inspector-column">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:11px; font-weight:bold; color:#888;">BASE VISUAL</span>
                    <button class="btn-icon" style="font-size:10px;" onclick="addVisualPlan()"><i
                            class="fas fa-plus"></i></button>
                </div>
                <div id="visual-plans-container"></div>
            </div>
            <div class="inspector-column overlay-col">
                <div style="font-size:11px; font-weight:bold; color:#888; margin-bottom:5px;">OVERLAY</div>
                <div
                    style="background:#222; padding:10px; border:1px solid #444; border-radius:4px; margin-bottom:15px;">
                    <textarea id="overlay-text" class="plan-textarea" placeholder="Overlay description..."></textarea>
                </div>
            </div>
        </div>
    </aside>

    <script type="module" src="js/main.js"></script>
    <script>
        // ★ [핵심 수정] UniversalData를 사용하도록 연결 함수 업데이트
        window.openEditor = (stage, type) => {
            if (!window.currPid) return alert("프로젝트를 먼저 선택해주세요.");

            // UniversalDataManager가 로드되었는지 확인
            if (!window.UniversalData) {
                console.error("UniversalData module not loaded yet.");
                return alert("시스템 초기화 중입니다. 잠시 후 다시 시도해주세요.");
            }

            // DB 키 생성 [pid, stage, type]
            const dbKey = [window.currPid, stage, type];
            const title = `${stage.toUpperCase()} : ${type}`;

            // Gems URL인 경우 예외 처리
            if (stage === 'gems') {
                window.UniversalData.open('stage_data', dbKey, `Gems URL (${type})`);
            } else {
                // 일반 프롬프트/JSON 에디터 열기
                window.UniversalData.open('stage_data', dbKey, title);
            }
        };

        // URL 열기 (Gems 등)
        window.openUrl = (stage, type) => {
            alert("URL 바로가기 기능은 준비 중입니다. Edit을 눌러 확인하세요.");
        };

        // Director로 로드
        window.loadToDirector = async () => {
            if (!window.currPid) return alert("프로젝트를 선택해주세요.");
            if (window.ProjectMgrInstance) {
                await window.ProjectMgrInstance.loadDirectorState();
            }

            // 탭 강제 전환
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));

            const dirBtn = document.querySelector('[data-target="director"]');
            const dirSec = document.getElementById('view-director');

            if (dirBtn) dirBtn.classList.add('active');
            if (dirSec) dirSec.classList.add('active');

            // 타임라인 리사이즈 (깨짐 방지)
            if (window.TimelineRendererInstance) {
                setTimeout(() => window.TimelineRendererInstance.fitTimeline(), 100);
            }
        };

        // Inspector 관련 헬퍼
        window.saveInspector = () => window.InspectorInstance?.save();
        window.addVisualPlan = () => window.InspectorInstance?.addVisualPlan();
        window.fitTimeline = () => window.TimelineRendererInstance?.fitTimeline();

        // 데이터 복사
        window.copyData = (stage, type) => {
            alert("Edit 버튼을 눌러 내용을 확인하고 복사하세요.");
        };
    </script>
</body>

</html>